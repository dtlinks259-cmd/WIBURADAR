<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WibuRadar - Universal Anime Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0a0a0c;
        }

        .glass-panel {
            background: rgba(18, 18, 22, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .anime-gradient {
            background: linear-gradient(to bottom, rgba(10, 10, 12, 0) 0%, rgba(10, 10, 12, 0.9) 70%, #0a0a0c 100%);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-modal { animation: fadeIn 0.3s ease-out forwards; }
        
        .tab-active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 1.5rem;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen">

    <!-- Privacy Policy Overlay -->
    <div id="tos-overlay" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 hidden">
        <div class="glass-panel p-8 rounded-[2.5rem] max-w-lg w-full text-center animate-modal shadow-2xl border border-white/10">
            <div class="w-16 h-16 bg-blue-600/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="shield-check" class="w-8 h-8 text-blue-500"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 text-white">Privacy & Terms</h2>
            <p class="text-xs text-gray-500 uppercase tracking-widest font-bold mb-6">Effective: Dec 25, 2024</p>
            
            <div class="text-gray-400 text-sm h-64 overflow-y-auto mb-8 pr-4 scrollbar-hide text-left border-y border-white/5 py-6 space-y-4">
                <p><strong class="text-white">1. Data Collection:</strong> WibuRadar utilizes Firebase and MongoDB Atlas to store tracking data anonymously.</p>
                <p><strong class="text-white">2. Affiliate Transparency:</strong> Shopping links contain affiliate tags (`wiburadar-21`). Purchases made support the app maintenance.</p>
                <p><strong class="text-white">3. Third-Party APIs:</strong> We integrate data from Jikan (MAL), Trace.moe, and Themes.moe.</p>
                <p><strong class="text-white text-red-500">4. Disclaimer:</strong> The owner assumes no responsibility for external content or marketplace transactions.</p>
            </div>

            <div class="flex gap-4">
                <button onclick="window.location.href='https://www.google.com'" class="flex-1 py-4 bg-white/5 rounded-2xl font-bold transition-all text-gray-400">Exit</button>
                <button onclick="acceptTOS()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-black shadow-lg shadow-blue-500/20 transition-all text-white">I Agree</button>
            </div>
        </div>
    </div>

    <!-- Scan Scene Modal -->
    <div id="scan-modal" class="fixed inset-0 z-[160] bg-black/95 backdrop-blur-xl hidden overflow-y-auto animate-modal flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-[2.5rem] max-w-4xl w-full border border-white/10 relative">
            <button onclick="closeScanModal()" class="absolute top-6 right-6 p-2 bg-white/10 rounded-full hover:bg-red-500 hover:text-white transition-all transform hover:rotate-90 z-20">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="flex-1">
                    <h2 class="text-2xl font-black text-white mb-6 flex items-center gap-2">
                        <i data-lucide="scan-eye" class="text-pink-500"></i> Scan Scene
                    </h2>
                    <div id="drop-zone" class="border-2 border-dashed border-white/10 rounded-3xl h-64 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-white/5 transition-all relative">
                        <input type="file" id="image-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="handleImageUpload(this)">
                        <div id="upload-placeholder">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-blue-500 mx-auto mb-4"></i>
                            <p class="font-bold text-white">Click or Drop Image</p>
                        </div>
                        <img id="image-preview" class="absolute inset-0 w-full h-full object-contain hidden p-4">
                    </div>
                    <button onclick="scanScene()" id="scan-btn" disabled class="w-full mt-6 py-4 bg-pink-600 hover:bg-pink-500 rounded-2xl font-black transition-all text-white disabled:opacity-30">Identify Anime</button>
                </div>
                <div class="flex-1 lg:border-l border-white/10 lg:pl-8">
                    <h3 class="text-lg font-bold text-white mb-4">Match Result</h3>
                    <div id="scan-result" class="flex flex-col items-center justify-center text-center min-h-[300px] text-gray-500 italic text-sm">Upload to identify...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass-panel border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="loadAnime(52991)">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"><i data-lucide="radar" class="w-5 h-5 text-white"></i></div>
                <span class="text-xl font-extrabold tracking-tighter text-white">WIBU<span class="text-blue-500">RADAR</span></span>
            </div>
            <div class="flex-1 max-w-md mx-8 relative flex items-center gap-2" id="search-container">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder="Search anime..." class="w-full bg-white/5 border border-white/10 rounded-full py-2 pl-10 pr-4 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                </div>
                <button onclick="openScanModal()" class="p-2 bg-white/5 hover:bg-pink-500/20 hover:text-pink-500 rounded-full border border-white/10 transition-all text-gray-400">
                    <i data-lucide="scan-eye" class="w-5 h-5"></i>
                </button>
                <div id="search-dropdown" class="absolute top-full mt-2 w-full glass-panel rounded-xl overflow-hidden hidden z-50 shadow-2xl"></div>
            </div>
            <div id="user-profile" class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center font-bold text-xs text-white">?</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16 pb-20">
        <div id="hero-section" class="relative w-full min-h-[70vh] flex items-center overflow-hidden">
            <div id="hero-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-1000 scale-100 opacity-40 blur-sm"></div>
            <div class="absolute inset-0 anime-gradient"></div>
            <div class="relative w-full max-w-7xl mx-auto px-4 py-12 flex flex-col lg:flex-row gap-12 items-center lg:items-end">
                <img id="hero-poster" src="" class="w-48 md:w-64 rounded-2xl shadow-2xl border-4 border-white/10 z-10 transition-transform hover:scale-105">
                <div class="flex-1 z-10 text-center lg:text-left">
                    <div class="flex flex-wrap items-center justify-center lg:justify-start gap-3 mb-6">
                        <span id="hero-type" class="px-3 py-1 rounded-full bg-blue-600 text-[10px] font-black uppercase tracking-widest text-white shadow-lg">TV</span>
                        <div class="flex items-center gap-1 text-yellow-500 font-bold bg-white/5 px-2 py-1 rounded-lg border border-white/5">
                            <i data-lucide="star" class="w-4 h-4 fill-current"></i><span id="hero-score">0.00</span>
                        </div>
                    </div>
                    <h1 id="hero-title" class="text-4xl md:text-7xl font-black mb-6 leading-none tracking-tighter text-white">Loading...</h1>
                    <p id="hero-synopsis" class="text-gray-300 max-w-2xl line-clamp-3 text-sm md:text-base mb-8 mx-auto lg:mx-0"></p>
                    <div class="flex flex-wrap justify-center lg:justify-start gap-4">
                        <div class="relative">
                            <button onclick="toggleStatusDropdown()" class="flex items-center gap-2 bg-blue-600 text-white hover:bg-blue-500 px-8 py-4 rounded-2xl font-black transition-all transform hover:scale-105 shadow-xl shadow-blue-900/40">
                                <i data-lucide="list-plus" class="w-5 h-5"></i> Update Radar
                            </button>
                            <div id="status-dropdown" class="absolute bottom-full left-0 mb-2 w-48 glass-panel rounded-xl overflow-hidden hidden border border-white/10 z-50">
                                <button onclick="handleStatusSelection('watching')" class="w-full text-left px-4 py-3 text-xs font-bold hover:bg-blue-600 text-white border-b border-white/5">Watching</button>
                                <button onclick="handleStatusSelection('completed')" class="w-full text-left px-4 py-3 text-xs font-bold hover:bg-green-600 text-white border-b border-white/5">Completed</button>
                                <button onclick="handleStatusSelection('plan_to_watch')" class="w-full text-left px-4 py-3 text-xs font-bold hover:bg-purple-600 text-white border-b border-white/5">Plan to Watch</button>
                                <button onclick="handleStatusSelection('dropped')" class="w-full text-left px-4 py-3 text-xs font-bold hover:bg-red-600 text-white">Dropped</button>
                            </div>
                        </div>
                        <button id="trailer-btn" onclick="openTrailer()" class="flex items-center gap-2 bg-white/10 text-white hover:bg-white/20 border border-white/10 px-8 py-4 rounded-2xl font-black transition-all">
                            <i data-lucide="play" class="w-5 h-5 fill-current"></i> Watch Trailer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 mt-12 grid grid-cols-1 lg:grid-cols-3 gap-12">
            <div class="lg:col-span-2 space-y-12">
                <!-- Navigation Tabs -->
                <div class="flex border-b border-white/10 gap-8 overflow-x-auto scrollbar-hide">
                    <button onclick="switchTab('info')" id="tab-info" class="pb-4 font-bold text-sm tab-active whitespace-nowrap">Overview</button>
                    <button onclick="switchTab('episodes')" id="tab-episodes" class="pb-4 font-bold text-sm text-gray-500 hover:text-white whitespace-nowrap">Episodes</button>
                    <button onclick="switchTab('characters')" id="tab-characters" class="pb-4 font-bold text-sm text-gray-500 hover:text-white whitespace-nowrap">Characters & VAs</button>
                    <button onclick="switchTab('music')" id="tab-music" class="pb-4 font-bold text-sm text-gray-500 hover:text-white whitespace-nowrap">Music</button>
                </div>

                <!-- Info Content -->
                <div id="content-info" class="space-y-12 animate-modal">
                    <!-- Trailer Box -->
                    <div id="trailer-section" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold flex items-center gap-2 text-white"><i data-lucide="film" class="text-blue-500"></i> Official Trailer</h3>
                            <button onclick="closeTrailer()" class="text-gray-500 hover:text-white"><i data-lucide="x-circle" class="w-6 h-6"></i></button>
                        </div>
                        <div id="trailer-player" class="video-container shadow-2xl border border-white/5"></div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="glass-panel p-6 rounded-3xl"><span class="text-[10px] text-gray-500 uppercase font-black block mb-1">Episodes</span><span id="info-episodes" class="text-2xl font-black text-white">?</span></div>
                        <div class="glass-panel p-6 rounded-3xl"><span class="text-[10px] text-gray-500 uppercase font-black block mb-1">Status</span><span id="info-status" class="text-lg font-black text-white truncate block">?</span></div>
                        <div class="glass-panel p-6 rounded-3xl"><span class="text-[10px] text-gray-500 uppercase font-black block mb-1">Duration</span><span id="info-duration" class="text-lg font-black text-white">?</span></div>
                        <div class="glass-panel p-6 rounded-3xl"><span class="text-[10px] text-gray-500 uppercase font-black block mb-1">Studio</span><span id="info-studio" class="text-lg font-black text-white truncate block">?</span></div>
                    </div>

                    <!-- Marketplace (Amazon) -->
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold flex items-center gap-2 text-white"><i data-lucide="shopping-cart" class="text-yellow-500"></i> Merchandise</h3>
                        <div id="shopping-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    </div>

                    <!-- Relations -->
                    <div id="relations-box" class="space-y-6 hidden">
                        <h3 class="text-xl font-bold flex items-center gap-2 text-white"><i data-lucide="git-merge" class="text-purple-500"></i> Anime Relations</h3>
                        <div id="relations-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>

                <!-- Episodes Content -->
                <div id="content-episodes" class="hidden animate-modal space-y-4">
                    <div id="episodes-list" class="grid grid-cols-1 gap-2"></div>
                </div>

                <!-- Characters Content -->
                <div id="content-characters" class="hidden animate-modal">
                    <div id="characters-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- Music Content -->
                <div id="content-music" class="hidden animate-modal space-y-6">
                    <div id="music-player-container" class="hidden glass-panel p-4 rounded-3xl border-blue-500/20">
                        <div class="flex justify-between items-center mb-4"><span id="now-playing" class="text-xs font-black text-blue-400 uppercase">Now Playing</span><button onclick="closeMusic()"><i data-lucide="x"></i></button></div>
                        <video id="theme-video" class="w-full aspect-video rounded-2xl bg-black" controls></video>
                    </div>
                    <div id="music-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <div class="glass-panel p-8 rounded-[2.5rem]">
                    <h3 class="text-xl font-bold mb-8 flex items-center gap-2 text-white"><i data-lucide="library" class="text-blue-500"></i> Your Library</h3>
                    <div id="my-list-preview" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 scrollbar-hide"></div>
                </div>
                <div id="staff-panel" class="glass-panel p-8 rounded-[2.5rem] hidden">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-white"><i data-lucide="mic-2" class="text-pink-500"></i> Core Staff</h3>
                    <div id="staff-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Progress Modal -->
    <div id="progress-modal" class="fixed inset-0 z-[150] bg-black/80 hidden flex items-center justify-center p-4">
        <div class="glass-panel p-10 rounded-[3rem] w-full max-w-sm text-center animate-modal shadow-2xl">
            <h3 class="text-2xl font-black mb-2 text-white">Update Tracker</h3>
            <p id="modal-title" class="text-xs text-gray-500 font-bold uppercase mb-8 truncate px-4"></p>
            <div class="flex items-center justify-center gap-8 mb-10">
                <button onclick="adjEp(-1)" class="w-14 h-14 bg-white/5 rounded-2xl text-2xl font-black hover:bg-blue-600">-</button>
                <div class="text-center"><span id="ep-count" class="text-6xl font-black text-blue-500">0</span><span class="block text-[10px] text-gray-500 font-black mt-2">EPISODES</span></div>
                <button onclick="adjEp(1)" class="w-14 h-14 bg-white/5 rounded-2xl text-2xl font-black hover:bg-blue-600">+</button>
            </div>
            <div class="flex gap-4">
                <button onclick="closeProgress()" class="flex-1 py-4 bg-white/5 rounded-2xl font-bold text-gray-400">Cancel</button>
                <button onclick="saveProgress()" class="flex-1 py-4 bg-blue-600 rounded-2xl font-black text-white">Save Progress</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'wiburadar-v1';

        // Amazon Config
        const AMAZON_TAG = "wiburadar-21";

        const state = {
            current: null,
            user: null,
            library: [],
            epCount: 0,
            pendingStatus: null,
            themes: [],
            uploadedFile: null
        };

        // --- UI Interactions ---
        window.acceptTOS = () => { localStorage.setItem('radar_tos', '1'); document.getElementById('tos-overlay').classList.add('hidden'); };
        window.toggleStatusDropdown = () => document.getElementById('status-dropdown').classList.toggle('hidden');
        window.closeScanModal = () => { 
            document.getElementById('scan-modal').classList.add('hidden');
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('scan-result').innerText = 'Upload to identify...';
        };
        window.openScanModal = () => document.getElementById('scan-modal').classList.remove('hidden');

        // --- Image Upload & Scan ---
        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                state.uploadedFile = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('upload-placeholder').classList.add('hidden');
                    const preview = document.getElementById('image-preview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    document.getElementById('scan-btn').disabled = false;
                };
                reader.readAsDataURL(state.uploadedFile);
            }
        };

        window.scanScene = async () => {
            if (!state.uploadedFile) return;
            const resDiv = document.getElementById('scan-result');
            const btn = document.getElementById('scan-btn');
            resDiv.innerHTML = `<div class="animate-pulse text-pink-500 text-center font-bold">Scanning Trace.moe database...</div>`;
            btn.disabled = true;
            try {
                const formData = new FormData();
                formData.append("image", state.uploadedFile);
                const res = await fetch("https://api.trace.moe/search", { method: "POST", body: formData });
                const data = await res.json();
                if (data.result?.length) {
                    const match = data.result[0];
                    // Map Anilist ID to MAL ID
                    const query = `query ($id: Int) { Media (id: $id, type: ANIME) { idMal title { english romaji } } }`;
                    const aniRes = await fetch("https://graphql.anilist.co", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ query, variables: { id: match.anilist } })
                    });
                    const aniData = await aniRes.json();
                    const media = aniData.data.Media;
                    
                    resDiv.innerHTML = `
                        <div class="bg-white/5 p-4 rounded-2xl border border-pink-500/20 text-center animate-modal">
                            <p class="text-xs text-pink-500 font-black uppercase mb-2">Match Found - ${Math.round(match.similarity * 100)}%</p>
                            <p class="text-sm font-bold text-white mb-4">${media.title.english || media.title.romaji}</p>
                            <button onclick="closeScanModal(); loadAnime(${media.idMal})" class="w-full py-3 bg-white text-black font-black rounded-xl">Go to Anime Info</button>
                        </div>
                    `;
                } else { resDiv.innerHTML = `<p class="text-red-500">No matches found.</p>`; }
            } catch (err) { resDiv.innerHTML = `<p class="text-red-500">Scan failed. Trace.moe or Anilist might be busy.</p>`; }
            finally { btn.disabled = false; }
        };

        // --- Media Controls ---
        window.openTrailer = () => {
            const trailer = state.current?.trailer;
            if (!trailer?.embed_url) return;
            const container = document.getElementById('trailer-section');
            const player = document.getElementById('trailer-player');
            container.classList.remove('hidden');
            player.innerHTML = `<iframe src="${trailer.embed_url}" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            container.scrollIntoView({ behavior: 'smooth' });
        };
        window.closeTrailer = () => {
            document.getElementById('trailer-section').classList.add('hidden');
            document.getElementById('trailer-player').innerHTML = '';
        };

        // --- Data Loading ---
        window.loadAnime = async (id) => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            closeTrailer();
            closeMusic();
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime/${id}/full`);
                const data = await res.json();
                state.current = data.data;
                renderHero();
                renderOverview();
                switchTab('info');
                
                // Secondary Fetches
                fetchEpisodes(id);
                fetchCharacters(id);
                fetchMusic(id);
                fetchStaff(id);
            } catch (err) { console.error(err); }
        };

        const renderHero = () => {
            const a = state.current;
            document.getElementById('hero-bg').style.backgroundImage = `url(${a.images.jpg.large_image_url})`;
            document.getElementById('hero-poster').src = a.images.jpg.large_image_url;
            document.getElementById('hero-title').innerText = a.title;
            document.getElementById('hero-synopsis').innerText = a.synopsis || "No description.";
            document.getElementById('hero-score').innerText = a.score || '0.00';
            document.getElementById('hero-type').innerText = a.type || 'TV';
            document.getElementById('trailer-btn').classList.toggle('hidden', !a.trailer?.embed_url);
            lucide.createIcons();
        };

        const renderOverview = () => {
            const a = state.current;
            document.getElementById('info-episodes').innerText = a.episodes || '?';
            document.getElementById('info-status').innerText = a.status;
            document.getElementById('info-duration').innerText = a.duration || 'N/A';
            document.getElementById('info-studio').innerText = a.studios?.[0]?.name || 'Unknown';
            
            // Shopping
            const query = encodeURIComponent(a.title);
            const tag = AMAZON_TAG ? `&tag=${AMAZON_TAG}` : "";
            const shopItems = [
                { n: 'Figures', i: 'box', c: 'yellow', q: 'figure' },
                { n: 'Manga', i: 'book', c: 'orange', q: 'manga' },
                { n: 'Light Novel', i: 'book-open', c: 'blue', q: 'light novel' }
            ];
            document.getElementById('shopping-grid').innerHTML = shopItems.map(item => `
                <a href="https://www.amazon.com/s?k=${query}+${item.q}${tag}" target="_blank" class="glass-panel p-4 rounded-3xl border-${item.c}-500/10 hover:border-${item.c}-500/50 group transition-all flex items-center gap-3">
                    <div class="w-10 h-10 bg-${item.c}-500/10 rounded-2xl flex items-center justify-center text-${item.c}-500"><i data-lucide="${item.i}" class="w-5 h-5"></i></div>
                    <div class="flex-1"><p class="text-[10px] text-gray-500 font-bold uppercase leading-none mb-1">Buy on Amazon</p><p class="text-sm font-black text-white">${item.n}</p></div>
                    <i data-lucide="external-link" class="w-4 h-4 text-gray-700 group-hover:text-white"></i>
                </a>
            `).join('');

            // Relations
            const relBox = document.getElementById('relations-box');
            const relGrid = document.getElementById('relations-grid');
            if (a.relations?.length) {
                relBox.classList.remove('hidden');
                relGrid.innerHTML = a.relations.map(r => r.entry.map(e => `
                    <div onclick="${e.type === 'anime' ? `loadAnime(${e.mal_id})` : `window.open('${e.url}')`}" class="glass-panel p-4 rounded-2xl flex items-center gap-3 cursor-pointer hover:bg-white/5 border border-white/5 group">
                        <div class="flex-1 min-w-0"><p class="text-xs font-black text-white truncate">${e.name}</p><p class="text-[9px] text-purple-400 font-black uppercase">${r.relation}</p></div>
                        <i data-lucide="arrow-right" class="w-4 h-4 text-gray-700 group-hover:text-white"></i>
                    </div>
                `).join('')).join('');
            } else { relBox.classList.add('hidden'); }
            lucide.createIcons();
        };

        const fetchEpisodes = async (id) => {
            const list = document.getElementById('episodes-list');
            list.innerHTML = `<div class="p-8 text-center animate-pulse text-gray-500 font-bold">Scrubbing logs...</div>`;
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime/${id}/episodes`);
                const data = await res.json();
                if (!data.data?.length) { list.innerHTML = `<div class="p-12 text-center text-gray-500 italic">No episode data available.</div>`; return; }
                list.innerHTML = data.data.map(ep => `
                    <div class="glass-panel p-4 rounded-2xl flex items-center justify-between border border-white/5 hover:border-blue-500/30 transition-all group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-white/5 rounded-xl flex items-center justify-center font-black text-blue-500">${ep.mal_id}</div>
                            <div class="min-w-0">
                                <p class="text-sm font-black text-white truncate w-48 md:w-80" title="${ep.title}">${ep.title}</p>
                                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">${ep.aired ? new Date(ep.aired).toLocaleDateString() : 'TBA'}</p>
                            </div>
                        </div>
                        ${ep.filler ? `<span class="px-2 py-1 rounded bg-red-500/20 text-red-500 text-[8px] font-black uppercase">Filler</span>` : ''}
                    </div>
                `).join('');
            } catch (err) { list.innerHTML = `<p class="text-red-500 text-center">Failed to load episodes.</p>`; }
        };

        const fetchCharacters = async (id) => {
            const grid = document.getElementById('characters-grid');
            grid.innerHTML = `<div class="col-span-full py-12 text-center animate-pulse text-blue-500">Retrieving cast...</div>`;
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime/${id}/characters`);
                const data = await res.json();
                grid.innerHTML = data.data.slice(0, 10).map(c => {
                    const va = c.voice_actors.find(v => v.language === 'Japanese');
                    return `
                        <div class="glass-panel p-4 rounded-3xl flex items-center gap-6 border border-white/5 group">
                            <div class="flex-1 flex items-center gap-3 min-w-0">
                                <img src="${c.character.images.jpg.image_url}" class="w-12 h-16 object-cover rounded-xl shadow-lg group-hover:scale-110 transition-transform">
                                <div class="min-w-0">
                                    <p class="text-xs font-black text-white truncate">${c.character.name}</p>
                                    <p class="text-[9px] text-blue-400 font-black uppercase">${c.role}</p>
                                </div>
                            </div>
                            ${va ? `
                                <div class="flex-1 flex items-center justify-end gap-3 min-w-0 text-right">
                                    <div class="min-w-0">
                                        <p class="text-xs font-black text-white truncate">${va.person.name}</p>
                                        <p class="text-[9px] text-pink-400 font-black uppercase">VOICE ACTOR</p>
                                    </div>
                                    <img src="${va.person.images.jpg.image_url}" class="w-12 h-16 object-cover rounded-xl shadow-lg border border-pink-500/20">
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (err) { grid.innerHTML = `<p class="text-red-500 text-center">Character data unreachable.</p>`; }
        };

        const fetchMusic = async (malId) => {
            const grid = document.getElementById('music-grid');
            try {
                const res = await fetch(`https://themes.moe/api/themes/search?q=${malId}`);
                const data = await res.json();
                state.themes = data[0]?.themes || [];
                if (state.themes.length) {
                    grid.innerHTML = state.themes.map((t, i) => `
                        <div onclick="playMusic(${i})" class="glass-panel p-5 rounded-3xl flex items-center justify-between group cursor-pointer hover:border-blue-500/50">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-blue-600/10 rounded-xl flex items-center justify-center text-blue-500 font-black">${t.type}</div>
                                <div class="min-w-0"><p class="text-sm font-black text-white truncate w-40">${t.name}</p><p class="text-[10px] text-gray-500 uppercase font-bold">Theme</p></div>
                            </div>
                            <i data-lucide="play" class="w-5 h-5 text-blue-500 fill-current opacity-0 group-hover:opacity-100"></i>
                        </div>
                    `).join('');
                } else { grid.innerHTML = `<p class="col-span-2 text-center text-gray-500">Themes not found.</p>`; }
            } catch (err) { }
            lucide.createIcons();
        };

        window.playMusic = (idx) => {
            const theme = state.themes[idx];
            const container = document.getElementById('music-player-container');
            const video = document.getElementById('theme-video');
            document.getElementById('now-playing').innerText = `PLAYING: ${theme.name}`;
            container.classList.remove('hidden');
            video.src = theme.mirror.mirrorURL;
            video.play();
            container.scrollIntoView({ behavior: 'smooth' });
        };
        window.closeMusic = () => {
            const v = document.getElementById('theme-video');
            v.pause(); v.src = "";
            document.getElementById('music-player-container').classList.add('hidden');
        };

        const fetchStaff = async (id) => {
            const panel = document.getElementById('staff-panel');
            const list = document.getElementById('staff-list');
            try {
                const res = await fetch(`https://api.jikan.moe/v4/anime/${id}/staff`);
                const data = await res.json();
                if (!data.data?.length) { panel.classList.add('hidden'); return; }
                panel.classList.remove('hidden');
                list.innerHTML = data.data.slice(0, 4).map(s => `
                    <div class="flex items-center gap-3 p-3 rounded-2xl bg-white/5 border border-white/5">
                        <img src="${s.person.images.jpg.image_url}" class="w-10 h-10 rounded-full object-cover">
                        <div class="min-w-0"><p class="text-xs font-black text-white truncate">${s.person.name}</p><p class="text-[9px] text-pink-500 font-bold uppercase">${s.positions[0]}</p></div>
                    </div>
                `).join('');
            } catch (err) { }
        };

        // --- Library Logic ---
        window.handleStatusSelection = (status) => {
            const existing = state.library.find(i => String(i.id) === String(state.current.mal_id));
            state.pendingStatus = status;
            state.epCount = existing?.episodesWatched || 0;
            document.getElementById('ep-count').innerText = state.epCount;
            document.getElementById('modal-title').innerText = state.current.title;
            document.getElementById('progress-modal').classList.remove('hidden');
            document.getElementById('status-dropdown').classList.add('hidden');
        };
        window.closeProgress = () => document.getElementById('progress-modal').classList.add('hidden');
        window.adjEp = (val) => { state.epCount = Math.max(0, state.epCount + val); document.getElementById('ep-count').innerText = state.epCount; };
        window.saveProgress = async () => {
            if (!state.user) return;
            const ref = doc(db, 'artifacts', appId, 'users', state.user.uid, 'library', String(state.current.mal_id));
            await setDoc(ref, { id: state.current.mal_id, title: state.current.title, image: state.current.images.jpg.large_image_url, status: state.pendingStatus, episodesWatched: state.epCount, totalEpisodes: state.current.episodes || 0, updatedAt: serverTimestamp() });
            closeProgress();
        };

        window.switchTab = (tab) => {
            ['info', 'episodes', 'characters', 'music'].forEach(t => {
                const el = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if (el) el.classList.toggle('hidden', t !== tab);
                if (btn) btn.className = `pb-4 font-bold text-sm transition-all ${t === tab ? 'tab-active' : 'text-gray-500 hover:text-white'}`;
            });
        };

        // --- Search ---
        const searchInput = document.getElementById('search-input');
        let searchTimer;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimer);
            const query = e.target.value.trim();
            if (query.length < 3) { document.getElementById('search-dropdown').classList.add('hidden'); return; }
            searchTimer = setTimeout(async () => {
                const res = await fetch(`https://api.jikan.moe/v4/anime?q=${query}&limit=5`);
                const data = await res.json();
                const dd = document.getElementById('search-dropdown');
                dd.innerHTML = data.data.map(a => `<div onclick="loadAnime(${a.mal_id}); document.getElementById('search-dropdown').classList.add('hidden')" class="p-3 hover:bg-white/10 cursor-pointer flex items-center gap-3 border-b border-white/5"><img src="${a.images.jpg.small_image_url}" class="w-10 h-14 object-cover rounded-lg"><div class="min-w-0"><p class="text-xs font-bold text-white truncate">${a.title}</p><p class="text-[10px] text-gray-500 font-bold uppercase">${a.type} â€¢ ${a.score || 'N/A'}</p></div></div>`).join('');
                dd.classList.remove('hidden');
            }, 500);
        });

        // --- Init ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                document.getElementById('user-profile').innerText = user.uid.slice(0, 2).toUpperCase();
                onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'library'), snap => {
                    state.library = snap.docs.map(d => d.data());
                    const container = document.getElementById('my-list-preview');
                    if (!state.library.length) { container.innerHTML = `<p class="text-xs text-gray-500 italic text-center py-4">Radar empty</p>`; return; }
                    container.innerHTML = state.library.sort((a,b) => b.updatedAt - a.updatedAt).map(item => `
                        <div class="p-4 rounded-2xl bg-white/5 border border-white/5 flex gap-3 items-center group animate-modal">
                            <img onclick="loadAnime(${item.id})" src="${item.image}" class="w-10 h-14 rounded-lg object-cover cursor-pointer hover:scale-105 transition-transform">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-black text-white truncate cursor-pointer" onclick="loadAnime(${item.id})">${item.title}</p>
                                <div class="flex items-center gap-2 mt-1"><span class="text-[9px] uppercase font-black text-blue-500">${item.status}</span><span class="text-[9px] text-gray-500 font-bold">${item.episodesWatched}/${item.totalEpisodes || '?'}</span></div>
                            </div>
                        </div>
                    `).join('');
                });
            }
        });

        const init = async () => {
            if (!localStorage.getItem('radar_tos')) document.getElementById('tos-overlay').classList.remove('hidden');
            await signInAnonymously(auth);
            loadAnime(52991);
        };
        init();
    </script>
</body>
</html>